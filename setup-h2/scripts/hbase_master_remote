#!/bin/bash
####FUNCTIONS####
setupPaswordless() {
echo "Setting passwordless shh to $1" 
expect <<EOD
spawn ssh-copy-id root@$1
expect "*you want to continue*"
send -- "yes\r"
expect "*?assword:*"
send -- "$2\r"
expect eof
EOD
}
####SETTINGS###
PASSWORD="#p@swd!srt2539471"

ulimit -n 999999
sysctl -w net.ipv4.tcp_tw_reuse=1
sysctl -w net.ipv4.tcp_tw_recycle=1
hostname master  
export HOSTNAME=master
echo "Installing java expect"
yum -y -q install expect java-1.7*

echo "Creating ssh key" 
ssh-keygen -t rsa -P "" -f "/root/.ssh/id_rsa"
setupPaswordless master $PASSWORD
setupPaswordless region1 $PASSWORD
setupPaswordless region2 $PASSWORD

scp /etc/hosts root@region1:/etc
scp /etc/hosts root@region2:/etc

service iptables stop 
chkconfig iptables off 

scp /opt/benchmark_setup_hbase_horizontal/region_remote1 root@region1:/opt
scp /opt/benchmark_setup_hbase_horizontal/region_remote2 root@region2:/opt
ssh region1 "/opt/region_remote1" &
wait
ssh region2 "/opt/region_remote2" &
wait
 
cd /opt
echo "Donwloading hadoop"
wget -q http://mirrors.ukfast.co.uk/sites/ftp.apache.org/hadoop/common/hadoop-1.2.1/hadoop-1.2.1.tar.gz
tar -xzf hadoop-1.2.1.tar.gz
mv hadoop-1.2.1 hadoop
mkdir /opt/hadoop/datastore
cp -f /opt/benchmark_setup_hbase_horizontal/hadoop/core-site.xml  /opt/hadoop/conf/core-site.xml
cp -f /opt/benchmark_setup_hbase_horizontal/hadoop/mapred-site.xml  /opt/hadoop/conf/mapred-site.xml
cp -f /opt/benchmark_setup_hbase_horizontal/hadoop/hdfs-site.xml  /opt/hadoop/conf/hdfs-site.xml
 
printf "\nexport JAVA_HOME=/usr/lib/jvm/java-1.7.0/jre \nexport HADOOP_HOME=/opt/hadoop \nexport HADOOP_CONF_DIR=/opt/hadoop/conf\n" >>/opt/hadoop/conf/hadoop-env.sh 

echo "Copying hadoop to region servers"
scp -r -q /opt/hadoop root@region1:/opt
scp -r -q /opt/hadoop root@region2:/opt

printf "region1\nregion2" > /opt/hadoop/conf/slaves
echo "master" > /opt/hadoop/conf/masters
/opt/hadoop/bin/hadoop namenode -format   

/opt/hadoop/bin/start-all.sh &
wait

echo "Setting up hbase"

cd /opt
echo "Downloading hbase"
wget -q http://mirrors.ukfast.co.uk/sites/ftp.apache.org/hbase/stable/hbase-0.94.14.tar.gz
tar xfz hbase-0.94.14.tar.gz 
mv hbase-0.94.14 hbase

cp hadoop/*.jar hbase/lib/

printf "export HBASE_MANAGES_ZK=true\nexport JAVA_HOME=/usr/lib/jvm/java-1.7.0/jre\nexport HBASE_CLASSPATH=/opt/hadoop/conf" >> /opt/hbase/conf/hbase-env.sh 

cp -f /opt/benchmark_setup_hbase_horizontal/hbase/hbase-site.xml  /opt/hbase/conf/hbase-site.xml

printf "region1\nregion2" > /opt/hbase/conf/regionservers   
  
echo "Copying configured hbase to region servers"
scp -r -q /opt/hbase root@region1:/opt/
scp -r -q /opt/hbase root@region2:/opt/

/opt/hbase/bin/start-hbase.sh &
wait
  
ssh region1 "/opt/hbase/bin/hbase-daemon.sh start rest -p 8080"
ssh region2 "/opt/hbase/bin/hbase-daemon.sh start rest -p 8080"